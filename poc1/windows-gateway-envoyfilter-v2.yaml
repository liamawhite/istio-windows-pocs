# EnvoyFilter for completely dynamic service routing
# Replaces the route destination based on the gateway pattern
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: windows-gateway-dynamic-router
  namespace: poc1
spec:
  workloadSelector:
    labels:
      istio: windows-gateway
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: GATEWAY
      routeConfiguration:
        vhost:
          route:
            action: ROUTE
    patch:
      operation: MERGE
      value:
        route:
          cluster_header: ":authority"  # Use authority header to determine cluster
          regex_rewrite:
            pattern:
              google_re2: {}
              regex: "^([a-zA-Z0-9-]+)-gateway:8080$"
            substitution: "outbound|8080||\\1.poc1.svc.cluster.local"